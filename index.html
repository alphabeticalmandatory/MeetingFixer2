<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Time Zone Meeting Scheduler</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background: #f5f5f5;
      padding: 1rem;
      max-width: 600px;
      margin: auto;
    }
    h1 {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: #0D47A1;
    }
    .card {
      background: white;
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    input[type="datetime-local"] {
      width: 100%;
      padding: 0.75rem;
      margin-top: 0.5rem;
      margin-bottom: 1rem;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    button {
      padding: 0.75rem;
      margin-right: 0.5rem;
      border: none;
      border-radius: 4px;
      font-weight: bold;
      cursor: pointer;
    }
    #proposeBtn {
      background-color: #1976D2;
      color: white;
    }
    #acceptBtn {
      background-color: #E3F2FD;
      color: #1976D2;
      border: 1px solid #1976D2;
    }
    .status {
      margin-top: 1rem;
      padding: 0.75rem;
      border-radius: 4px;
      background: #eee;
    }
    .share-box {
      display: flex;
      margin-top: 1rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      overflow: hidden;
    }
    .share-box input {
      flex: 1;
      padding: 0.5rem;
      border: none;
    }
    .share-box button {
      padding: 0 1rem;
      border: none;
      background: #1976D2;
      color: white;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1><span class="material-icons">schedule</span> Meeting Scheduler</h1>
    <div><strong>Your Time Zone:</strong> <span id="timezone"></span></div>

    <label for="datetime">Propose Meeting Time:</label>
    <input type="datetime-local" id="datetime" />

    <div>
      <button id="proposeBtn">Propose</button>
      <button id="acceptBtn">Accept</button>
    </div>

    <div class="status" id="status">No meeting proposed yet.</div>
    <div id="localView"></div>

    <div class="share-box">
      <input type="text" id="shareInput" readonly value="Loading...">
      <button id="copyBtn">Copy</button>
    </div>
  </div>

  <!-- Load Yjs & y-webrtc from jsDelivr -->
  <script src="https://cdn.jsdelivr.net/npm/yjs@13.6.9/dist/yjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/y-webrtc@10.5.2/dist/y-webrtc.min.js"></script>

  <script>
    window.addEventListener('DOMContentLoaded', () => {
      if (typeof Y === 'undefined') {
        alert("‚ùå Yjs failed to load.");
        return;
      }
      if (typeof WebrtcProvider === 'undefined') {
        alert("‚ùå y-webrtc failed to load.");
        return;
      }
      alert("‚úÖ Yjs and y-webrtc loaded successfully.");
      
      const localTZ = Intl.DateTimeFormat().resolvedOptions().timeZone;
      document.getElementById('timezone').textContent = localTZ;

      const ydoc = new Y.Doc();
      let room = location.hash.slice(1);
      if (!room) {
        room = Math.random().toString(36).substring(2);
        location.hash = room;
      }

      const shareInput = document.getElementById('shareInput');
      shareInput.value = window.location.href;

      document.getElementById('copyBtn').onclick = () => {
        shareInput.select();
        document.execCommand("copy");
        alert("üîó Link copied to clipboard!");
      };

      const provider = new WebrtcProvider(room, ydoc);
      const ymap = ydoc.getMap('meeting');

      provider.on('synced', () => {
        alert("üîó You have joined the meeting room!");
      });

      const datetimeInput = document.getElementById('datetime');
      const proposeBtn = document.getElementById('proposeBtn');
      const acceptBtn = document.getElementById('acceptBtn');
      const status = document.getElementById('status');
      const localView = document.getElementById('localView');

      function formatTime(utcStr) {
        try {
          const date = new Date(utcStr);
          return date.toLocaleString(undefined, {
            timeZone: localTZ,
            year: 'numeric', month: 'long', day: 'numeric',
            hour: '2-digit', minute: '2-digit', weekday: 'long'
          });
        } catch (e) {
          return 'Invalid time';
        }
      }

      function updateUI() {
        const time = ymap.get('time');
        const accepted = ymap.get('acceptedBy') || [];

        if (time) {
          localView.textContent = "Meeting Time in Your Time Zone: " + formatTime(time);
          if (accepted.includes(localTZ)) {
            status.textContent = "‚úÖ You have accepted this meeting.";
          } else {
            status.textContent = "‚è≥ Meeting proposed. Awaiting your acceptance.";
          }
        } else {
          localView.textContent = "";
          status.textContent = "No meeting proposed yet.";
        }
      }

      proposeBtn.onclick = () => {
        const value = datetimeInput.value;
        if (!value) {
          alert("‚ö†Ô∏è Please select a valid date and time.");
          return;
        }
        const isoTime = new Date(value).toISOString();
        ymap.set('time', isoTime);
        ymap.set('acceptedBy', []);
        alert("‚úÖ Meeting proposed successfully!");
        datetimeInput.value = "";
      };

      acceptBtn.onclick = () => {
        const time = ymap.get('time');
        if (!time) {
          alert("‚ö†Ô∏è No meeting proposed yet.");
          return;
        }
        const accepted = ymap.get('acceptedBy') || [];
        if (!accepted.includes(localTZ)) {
          ymap.set('acceptedBy', [...accepted, localTZ]);
          alert("‚úÖ You have accepted the meeting.");
        } else {
          alert("‚ÑπÔ∏è You already accepted this meeting.");
        }
      };

      ymap.observe(updateUI);
      updateUI();
    });
  </script>
</body>
</html>

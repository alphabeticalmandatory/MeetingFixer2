<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Meeting Scheduler with Alerts</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      max-width: 600px;
      margin: auto;
    }
    input, button {
      padding: 10px;
      margin: 5px 0;
      width: 100%;
      font-size: 1rem;
    }
    .status {
      padding: 10px;
      border-radius: 5px;
      margin-top: 10px;
    }
    .accepted {
      background: #d4edda;
      color: #155724;
    }
    .pending {
      background: #fff3cd;
      color: #856404;
    }
    .empty {
      background: #f8d7da;
      color: #721c24;
    }
  </style>
</head>
<body>

<h2>Meeting Scheduler</h2>
<p>Time zone: <span id="timezone"></span></p>

<input type="datetime-local" id="datetime">
<button id="proposeBtn">Propose Meeting</button>
<button id="acceptBtn">Accept</button>

<h3>Your Local View</h3>
<div id="localView"></div>
<div id="status" class="status empty">Waiting for proposal...</div>

<h3>Share this link</h3>
<input id="shareInput" readonly>
<button id="copyBtn">Copy Link</button>

<!-- Libraries -->
<script src="https://unpkg.com/yjs"></script>
<script src="https://unpkg.com/y-webrtc"></script>

<script>
  if (typeof Y === 'undefined') {
    alert("‚ùå Yjs failed to load.");
    throw new Error("Yjs not loaded");
  }

  if (typeof WebrtcProvider === 'undefined') {
    alert("‚ùå y-webrtc failed to load.");
    throw new Error("y-webrtc not loaded");
  }

  const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
  document.getElementById('timezone').textContent = timezone;

  // Generate or get room ID
  const urlParams = new URLSearchParams(window.location.search);
  let room = urlParams.get('room');
  if (!room) {
    room = Math.random().toString(36).substring(2);
    window.location.search = '?room=' + room;
  } else {
    alert("‚úÖ Joined room: " + room);
  }

  const shareInput = document.getElementById('shareInput');
  shareInput.value = window.location.href;

  document.getElementById('copyBtn').onclick = () => {
    shareInput.select();
    document.execCommand('copy');
    alert("üìã Link copied to clipboard!");
  };

  const ydoc = new Y.Doc();
  const provider = new WebrtcProvider(room, ydoc);
  const ymap = ydoc.getMap('meeting');

  const datetimeInput = document.getElementById('datetime');
  const localView = document.getElementById('localView');
  const status = document.getElementById('status');

  function formatTime(utcStr) {
    try {
      const date = new Date(utcStr);
      return date.toLocaleString(undefined, {
        timeZone: timezone,
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    } catch {
      return 'Invalid time';
    }
  }

  function updateDisplay() {
    const time = ymap.get('time');
    const accepted = ymap.get('acceptedBy') || [];

    if (time) {
      localView.textContent = formatTime(time);

      if (accepted.includes(timezone)) {
        status.className = 'status accepted';
        status.textContent = "‚úÖ You have accepted this meeting.";
      } else {
        status.className = 'status pending';
        status.textContent = "‚è≥ Pending your acceptance.";
      }
    } else {
      localView.textContent = "";
      status.className = 'status empty';
      status.textContent = "‚ùó No meeting proposed yet.";
    }
  }

  document.getElementById('proposeBtn').onclick = () => {
    const value = datetimeInput.value;
    if (!value) {
      alert("‚ö†Ô∏è Please select a valid date and time.");
      return;
    }

    const localDate = new Date(value);
    if (isNaN(localDate.getTime())) {
      alert("‚ö†Ô∏è Invalid date/time.");
      return;
    }

    const isoString = localDate.toISOString();
    ymap.set('time', isoString);
    ymap.set('acceptedBy', []);
    alert("üìÖ Meeting proposed successfully!");
    datetimeInput.value = '';
  };

  document.getElementById('acceptBtn').onclick = () => {
    const time = ymap.get('time');
    if (!time) {
      alert("‚ö†Ô∏è No meeting has been proposed.");
      return;
    }

    const accepted = ymap.get('acceptedBy') || [];
    if (!accepted.includes(timezone)) {
      ymap.set('acceptedBy', [...accepted, timezone]);
      alert("‚úÖ You accepted the meeting.");
    } else {
      alert("‚ÑπÔ∏è You already accepted this meeting.");
    }
  };

  ymap.observe(updateDisplay);
  updateDisplay();
</script>
</body>
</html>
